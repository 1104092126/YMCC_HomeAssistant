# Home Assistant 配置文件 - HTTP 优化版本
# 使用 BetterDisplay HTTP API 替代 SSH + Shell 脚本
# 优势：
# 1. 无需 SSH 连接，减少网络依赖
# 2. 响应速度更快
# 3. 配置更简洁
# 4. 更好的错误处理能力

# =============================================================================
# ⚙️ 配置变量说明
# =============================================================================
#
# 所有配置变量都在 secrets.yaml 文件中定义
# 请编辑 homeassistant-script/secrets.yaml 文件来修改配置
#
# 配置变量列表：
# - betterdisplay_host: BetterDisplay 主机地址
# - betterdisplay_port: BetterDisplay HTTP 端口
# - remote_windows_ip: Windows PC IP 地址
# - remote_windows_username: Windows PC 用户名
# - reverse_proxy_ip: 反向代理 IP（可选）
# - betterdisplay_token: BetterDisplay API Token（可选）
#
# 在下方代码中使用 !secret 来引用这些变量
# =============================================================================

# =============================================================================
# 基础配置
# =============================================================================

default_config:

frontend:
  themes: !include_dir_merge_named themes

# =============================================================================
# 模块化配置引用
# =============================================================================

automation: !include automations.yaml
script: !include scripts.yaml
scene: !include scenes.yaml

# =============================================================================
# HTTP配置
# =============================================================================

http:
  use_x_forwarded_for: true
  trusted_proxies:
    - !secret reverse_proxy_ip

# =============================================================================
# Shell命令配置 - 使用 BetterDisplay HTTP API
# =============================================================================
#
# 显示器1 (LG ULTRAGEAR) 切换到 Windows
# 显示器1 (LG ULTRAGEAR) 切换到 macOS
# 显示器2 (AG273QG3R3B) 切换到 Windows
# 显示器2 (AG273QG3R3B) 切换到 macOS
# 远程关机 Windows（此功能仍需 SSH，因为 Windows 不支持 BetterDisplay）

# 如果 BetterDisplay 设置了访问令牌，在下面的命令 URL 末尾添加 &token=your_token_here

shell_command:
  # 显示器1切换到 Windows
  switch_monitor1_to_windows: >
    curl -s http://192.168.31.236:55777/set?namelike=LG%20ULTRAGEAR&ddcAlt=208&vcp=inputSelectAlt&token=homeassistant
  # 显示器1切换到 macOS
  switch_monitor1_to_macos: >
    curl -s http://192.168.31.236:55777/set?namelike=LG%20ULTRAGEAR&ddcAlt=144&vcp=inputSelectAlt&token=homeassistant
  # 显示器2切换到 Windows
  switch_monitor2_to_windows: >
    curl -s http://192.168.31.236:55777/set?namelike=AG273QG3R3B&ddc=17&vcp=inputSelect&token=homeassistant
  # 显示器2切换到 macOS
  switch_monitor2_to_macos: >
    curl -s http://192.168.31.236:55777/set?namelike=AG273QG3R3B&ddc=15&vcp=inputSelect&token=homeassistant
  # 远程关机 Windows（此功能仍需 SSH，因为 Windows 不支持 BetterDisplay）
  shutdown_remote_windows: >
    ssh {{ secrets.remote_windows_username }}@{{ secrets.remote_windows_ip }} "shutdown /s /t 0"

# =============================================================================
# 模板开关配置
# =============================================================================

light:
  - platform: template
    lights:
      # 显示器1输入源灯光
      monitor1_input: 
        friendly_name: "LG显示器"
        unique_id: "template_light_monitor1_input"
        value_template: "{{ states('input_text.monitor1_state') == 'windows' }}"
        turn_on:
          - service: shell_command.switch_monitor1_to_windows
          - service: input_text.set_value
            target:
              entity_id: input_text.monitor1_state
            data:
              value: 'windows'
        turn_off:
          - service: shell_command.switch_monitor1_to_macos
          - service: input_text.set_value
            target:
              entity_id: input_text.monitor1_state
            data:
              value: 'macos'

      # 显示器2输入源灯光
      monitor2_input: 
        friendly_name: "AG显示器"
        unique_id: "template_light_monitor2_input"
        value_template: "{{ states('input_text.monitor2_state') == 'windows' }}"
        turn_on:
          - service: shell_command.switch_monitor2_to_windows
          - service: input_text.set_value
            target:
              entity_id: input_text.monitor2_state
            data:
              value: 'windows'
        turn_off:
          - service: shell_command.switch_monitor2_to_macos
          - service: input_text.set_value
            target:
              entity_id: input_text.monitor2_state
            data:
              value: 'macos'

      # 远程开关机灯控制
      windows11_power: 
        friendly_name: "Windows11"
        unique_id: "template_light_windows11_power"
        value_template: "{{ states('input_boolean.remote_shutdown_switch') }}"
        turn_on:
          - service: button.press
            target:
              entity_id: button.wake_on_lan_e8_9c_25_7d_2f_7e
          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.remote_shutdown_switch
        turn_off:
          - service: shell_command.shutdown_remote_windows
          - service: input_boolean.turn_off
            target:
              entity_id: input_boolean.remote_shutdown_switch
        icon_template: "mdi:power"

# =============================================================================
# 输入实体配置
# =============================================================================

input_text:
  monitor1_state:
    name: LG显示器 State
    initial: 'macos'
    max: 10
  
  monitor2_state:
    name: AG显示器 State
    initial: 'macos'
    max: 10

input_boolean:
  remote_shutdown_switch:
    name: "Windows远程关机开关"
    initial: off

# =============================================================================
# 传感器配置
# =============================================================================

sensor:
  - platform: template
    sensors:
      # KVM状态传感器
      kvm_current_state:
        friendly_name: "KVM当前状态"
        unique_id: "template_sensor_kvm_current_state"
        value_template: >
          {{ 'Windows' if is_state('light.zimi_cn_1057968526_dhkg02_s_10_indicator_light', 'on') else 'MacOS' }}
        icon_template: "mdi:switch"
      
      # Windows11电脑状态传感器
      windows_pc_power_state:
        friendly_name: "Windows电脑状态（功率检测）"
        unique_id: "template_sensor_windows_pc_power_state"
        value_template: >
          {{ 'On' if (states('sensor.chuangmi_cn_494346355_212a01_electric_power_p_5_6') | float(0) > 5.0) else 'Off' }}
        icon_template: >
          {{ 'mdi:laptop-on' if is_state('sensor.windows_pc_power_state', 'On') else 'mdi:laptop-off' }}

